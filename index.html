<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPTV Premium</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="logo.png" />
  <style>
    body { margin:0; font-family:sans-serif; background:#121212; color:#fff }
    header { display:flex; align-items:center; padding:10px; background:#1e1e1e }
    header img { height:40px; margin-right:10px }
    header h1 { font-size:1.2rem }
    .controls { display:flex; flex-wrap:wrap; padding:10px; background:#222; gap:5px }
    .controls input, .controls select, .controls button { padding:6px; background:#333; color:#fff; border:none; border-radius:4px }
    .video-container { position:relative; padding-top:56.25% }
    video { position:absolute; top:0; left:0; width:100%; height:100% }
    .banner { padding:10px; background:#000; display:flex; align-items:center }
    .banner img { height:30px; margin-right:10px }
    .category-bar { padding:10px; overflow-x:auto; white-space:nowrap; background:#111 }
    .category-bar button { margin:0 5px; padding:6px 12px; background:#333; color:#fff; border:none; border-radius:4px }
    .category-bar button.active { background:#555 }
    .channels { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; padding:10px }
    .channel { background:#1f1f1f; padding:10px; border-radius:8px; text-align:center; cursor:pointer; transition:0.2s }
    .channel:hover { background:#333 }
    .channel img { width:100%; height:70px; object-fit:cover }
  </style>
</head>
<body>

  <header>
    <img src="logo.png" alt="Logo">
    <h1>IPTV Premium</h1>
  </header>

  <div class="controls">
    <input type="text" id="search" placeholder="Search channels">
    <select id="sort"><option value="az">Sort Aâ€“Z</option><option value="most">Most Watched</option></select>
    <button onclick="toggleDark()">ðŸŒ“ Theme</button>
    <button onclick="alert('Cast placeholder')">ðŸ“º Cast</button>
  </div>

  <div class="banner">
    <img id="nowIcon" src="logo.png" alt="Playing">
    <div id="nowText">Now Playing: None</div>
  </div>

  <div class="video-container"><video id="player" controls autoplay muted playsinline></video></div>

  <div class="category-bar" id="categoryBar"><!-- Populated dynamically --></div>
  <div class="channels" id="channelList"><!-- Populated dynamically --></div>

  <script>
    const M3U = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/main/IPTVPREMIUM.m3u";
    let channels = [], currentCat="All", fav=[], historyArr=[];
    const player = document.getElementById("player");
    const nowIcon = document.getElementById("nowIcon");
    const nowText = document.getElementById("nowText");
    const search = document.getElementById("search");
    const sortSel = document.getElementById("sort");
    const categoryBar = document.getElementById("categoryBar");
    const channelList = document.getElementById("channelList");

    function fetchList(){
      fetch(M3U).then(r=>r.text()).then(parseM3U);
    }
    function parseM3U(txt){
      const lines=txt.split("\n"), list=[];
      for(let i=0;i<lines.length;i++){
        if(lines[i].startsWith("#EXTINF")){
          const name=lines[i].match(/,(.*)$/)?.[1]||"";
          const logo=lines[i].match(/tvg-logo="(.*?)"/)?.[1]||"logo.png";
          const group=lines[i].match(/group-title="(.*?)"/)?.[1]||"Other";
          const url=lines[i+1]?.trim();
          if(url) list.push({name, logo, url, group, watched:0});
        }
      }
      channels=list;
      renderCats();
      applyFilters();
      restoreLast();
    }

    function renderCats(){
      const cats=["All","Favorites",...new Set(channels.map(c=>c.group))];
      categoryBar.innerHTML = cats.map(c=>`<button onclick="selectCat('${c}')" class="${c==='All'?'active':''}">${c}</button>`).join('');
    }

    function selectCat(c){
      currentCat=c;
      [...categoryBar.children].forEach(b=>b.classList.toggle("active", b.textContent===c));
      applyFilters();
    }

    function applyFilters(){
      let list=channels;
      if(currentCat==="Favorites") list=list.filter(c=>fav.includes(c.name));
      else if(currentCat!=="All") list=list.filter(c=>c.group===currentCat);
      const q=search.value.toLowerCase();
      if(q) list=list.filter(c=>c.name.toLowerCase().includes(q));
      if(sortSel.value==="az") list=list.sort((a,b)=>a.name.localeCompare(b.name));
      renderChannels(list);
    }

    function renderChannels(list){
      channelList.innerHTML = "";
      list.forEach(c=>{
        const div=document.createElement("div");
        div.className="channel";
        div.innerHTML = `<img src="${c.logo}" onerror="this.src='logo.png'"><div>${c.name}</div>`;
        div.onclick=()=>play(c);
        channelList.appendChild(div);
      });
    }

    function play(c){
      player.src = c.url;
      nowText.textContent = "Now Playing: " + c.name;
      nowIcon.src = c.logo;
      c.watched++;
      historyArr.push({name:c.name, time:Date.now()});
      localStorage.setItem("history", JSON.stringify(historyArr));
      localStorage.setItem("last", c.name);
    }

    function toggleDark(){
      document.body.classList.toggle("dark");
    }

    search.oninput=applyFilters;
    sortSel.onchange=applyFilters;

    document.addEventListener("keydown", e=>{
      let idx=channels.findIndex(c=>c.url===player.src);
      if(e.key==="ArrowRight") play(channels[(idx+1)%channels.length]);
      if(e.key==="ArrowLeft") play(channels[(idx-1+channels.length)%channels.length]);
    });

    window.onload=()=>{
      fav=JSON.parse(localStorage.getItem("fav")||"[]");
      historyArr=JSON.parse(localStorage.getItem("history")||"[]");
      fetchList();
      const lst=localStorage.getItem("last");
      if(lst){
        setTimeout(()=>play(channels.find(c=>c.name===lst)), 500);
      }
    };
  </script>
</body>
</html>
