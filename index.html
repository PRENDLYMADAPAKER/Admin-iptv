<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - NZM IPTV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url('https://i.ibb.co/s61PDpF/anonymous-vendetta-mask-dark.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      backdrop-filter: blur(8px);
    }
    .container {
      max-width: 960px;
      margin: auto;
      padding: 20px;
      background-color: rgba(0,0,0,0.6);
      border-radius: 12px;
    }
    h1 { text-align: center; color: #ff007f; }
    .section { margin-bottom: 40px; }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 6px;
      border: none;
    }
    input { width: 200px; background: #222; color: white; }
    button {
      background: #ff007f;
      color: white;
      cursor: pointer;
    }
    button.danger { background: #e53935; }
    .user-card {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .user-card h3 {
      margin: 0 0 8px 0;
      color: #ff66a3;
    }
    .session {
      font-size: 0.9rem;
      margin-left: 10px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NZM Admin Panel</h1>

    <div class="section">
      <h2>Create New Account</h2>
      <input type="email" id="newEmail" placeholder="Email">
      <input type="password" id="newPassword" placeholder="Password">
      <button onclick="createAccount()">Create</button>
      <p id="createStatus"></p>
    </div>

    <div class="section">
      <h2>User List</h2>
      <div id="userList">Loading...</div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA0TjMoFSYBIs0VQ9shUilOuDGb1uXHjKI",
      authDomain: "iptv-log-in.firebaseapp.com",
      databaseURL: "https://iptv-log-in-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iptv-log-in",
      storageBucket: "iptv-log-in.appspot.com",
      messagingSenderId: "820026131349",
      appId: "1:820026131349:web:417abd6ad9057c55a92c9c"
    };
    firebase.initializeApp(firebaseConfig);
    const functions = firebase.functions();
    const db = firebase.database();

    async function createAccount() {
      const email = document.getElementById("newEmail").value;
      const password = document.getElementById("newPassword").value;
      const status = document.getElementById("createStatus");
      status.textContent = "Creating...";

      try {
        const createUser = functions.httpsCallable('createUser');
        const result = await createUser({ email, password });
        status.textContent = `✅ Created user: ${result.data.uid}`;
        loadUsers();
      } catch (err) {
        status.textContent = "❌ Error: " + err.message;
      }
    }

    async function loadUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "Loading users...";
      try {
        const listUsers = functions.httpsCallable('listUsers');
        const result = await listUsers();
        const users = result.data.users;
        list.innerHTML = "";

        users.forEach(user => {
          const div = document.createElement("div");
          div.className = "user-card";
          div.innerHTML = `<h3>${user.email || "No Email"} <small>(${user.uid})</small></h3>`;

          const banBtn = document.createElement("button");
          banBtn.textContent = user.disabled ? "Unban" : "Ban";
          banBtn.onclick = () => toggleBan(user.uid, !user.disabled);

          div.appendChild(banBtn);

          // Fetch sessions
          const sessionsRef = db.ref(`sessions/${user.uid}`);
          sessionsRef.once("value").then(snapshot => {
            const sessions = snapshot.val() || {};
            Object.keys(sessions).forEach(sid => {
              const p = document.createElement("p");
              p.className = "session";
              const d = new Date(sessions[sid]);
              p.textContent = `Device: ${sid} — ${d.toLocaleString()}`;

              const logoutBtn = document.createElement("button");
              logoutBtn.textContent = "Force Logout";
              logoutBtn.className = "danger";
              logoutBtn.onclick = () => forceLogout(user.uid, sid);

              p.appendChild(logoutBtn);
              div.appendChild(p);
            });
          });

          list.appendChild(div);
        });

      } catch (err) {
        list.innerHTML = "❌ Error: " + err.message;
      }
    }

    async function toggleBan(uid, disable) {
      try {
        const toggle = functions.httpsCallable("toggleBan");
        await toggle({ uid, disable });
        alert(`User ${disable ? "banned" : "unbanned"}`);
        loadUsers();
      } catch (e) {
        alert("❌ " + e.message);
      }
    }

    function forceLogout(uid, sessionId) {
      db.ref(`sessions/${uid}/${sessionId}`).remove()
        .then(() => alert("✅ Session removed"))
        .catch(err => alert("❌ Error: " + err.message));
    }

    loadUsers();
  </script>
</body>
</html>
