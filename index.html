<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPTV Carousel Web App</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
    .video-container { position: sticky; top: 0; background: #000; z-index: 1000; }
    video { width: 100%; height: 300px; background: #000; }

    .controls { padding: 1rem; }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 5px;
    }

    .carousel-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      overflow: hidden;
    }

    .carousel {
      display: flex;
      transition: transform 0.3s ease-in-out;
      width: 100%;
    }

    .carousel-slide {
      min-width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
      box-sizing: border-box;
    }

    .channel {
      background: #222;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .channel:hover {
      background: #333;
    }

    .channel img {
      width: 100%;
      height: 80px;
      object-fit: contain;
      background: #000;
      border-radius: 4px;
    }

    .favorite {
      color: gold;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .nav-btn {
      background: #111;
      border: none;
      color: #fff;
      font-size: 2rem;
      padding: 0 1rem;
      cursor: pointer;
      z-index: 10;
      height: 100%;
    }
  </style>
</head>
<body>

<div class="video-container">
  <video id="player" controls autoplay></video>
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Search channels..." />
  <select id="category"></select>
</div>

<div class="carousel-wrapper">
  <button id="prevBtn" class="nav-btn">⟨</button>
  <div class="carousel" id="channelGrid"></div>
  <button id="nextBtn" class="nav-btn">⟩</button>
</div>

<script>
  const m3uUrl = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/refs/heads/main/IPTVPREMIUM.m3u";
  const player = document.getElementById("player");
  const grid = document.getElementById("channelGrid");
  const searchInput = document.getElementById("search");
  const categorySelect = document.getElementById("category");

  let channels = [], filtered = [], currentIndex = 0;
  let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

  function parseM3U(data) {
    const lines = data.split(/\r?\n/);
    const result = [];
    let current = {};

    lines.forEach(line => {
      if (line.startsWith("#EXTINF")) {
        const nameMatch = line.match(/,(.*)$/);
        const logoMatch = line.match(/tvg-logo="(.*?)"/);
        const groupMatch = line.match(/group-title="(.*?)"/);
        current = {
          name: nameMatch ? nameMatch[1] : "Unknown",
          logo: logoMatch ? logoMatch[1] : "",
          group: groupMatch ? groupMatch[1] : "Other"
        };
      } else if (line && !line.startsWith("#")) {
        current.url = line;
        result.push({ ...current });
      }
    });
    return result;
  }

  function updateCategoryOptions() {
    const allGroups = ["All", "Favorites", ...new Set(channels.map(c => c.group))];
    categorySelect.innerHTML = allGroups.map(g => `<option value="${g}">${g}</option>`).join("");
  }

  function chunkArray(arr, size) {
    const result = [];
    for (let i = 0; i < arr.length; i += size) {
      result.push(arr.slice(i, i + size));
    }
    return result;
  }

  function renderChannels() {
    const search = searchInput.value.toLowerCase();
    const category = categorySelect.value;
    filtered = channels.filter(c =>
      (category === "All" || (category === "Favorites" && favorites.includes(c.url)) || c.group === category) &&
      c.name.toLowerCase().includes(search)
    );

    const slides = chunkArray(filtered, 2);
    const channelGrid = document.getElementById("channelGrid");

    channelGrid.innerHTML = slides.map(slide => `
      <div class="carousel-slide">
        ${slide.map(ch => `
          <div class="channel" onclick="playChannelByUrl('${ch.url}')">
            <img src="${ch.logo || 'https://via.placeholder.com/150x80?text=No+Logo'}" />
            <div>${ch.name}</div>
            <div class="favorite" onclick="toggleFavorite(event, '${ch.url}')">
              ${favorites.includes(ch.url) ? "★ Favorite" : "☆ Add Favorite"}
            </div>
          </div>
        `).join("")}
      </div>
    `).join("");

    currentIndex = 0;
    updateCarousel();
  }

  function playChannelByUrl(url) {
    const ch = channels.find(c => c.url === url);
    if (ch) {
      player.src = ch.url;
      player.play();
    }
  }

  function toggleFavorite(event, url) {
    event.stopPropagation();
    if (favorites.includes(url)) {
      favorites = favorites.filter(f => f !== url);
    } else {
      favorites.push(url);
    }
    localStorage.setItem("favorites", JSON.stringify(favorites));
    renderChannels();
  }

  function updateCarousel() {
    const carousel = document.getElementById("channelGrid");
    carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
  }

  document.getElementById("prevBtn").onclick = () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  };

  document.getElementById("nextBtn").onclick = () => {
    const maxSlide = Math.ceil(filtered.length / 2) - 1;
    if (currentIndex < maxSlide) {
      currentIndex++;
      updateCarousel();
    }
  };

  // Swipe Support
  let touchStartX = 0;
  grid.addEventListener("touchstart", (e) => {
    touchStartX = e.changedTouches[0].clientX;
  });

  grid.addEventListener("touchend", (e) => {
    const diffX = e.changedTouches[0].clientX - touchStartX;
    if (diffX > 50) document.getElementById("prevBtn").click();
    else if (diffX < -50) document.getElementById("nextBtn").click();
  });

  searchInput.addEventListener("input", renderChannels);
  categorySelect.addEventListener("change", renderChannels);

  // Init
  fetch(m3uUrl)
    .then(res => res.text())
    .then(data => {
      channels = parseM3U(data);
      updateCategoryOptions();
      renderChannels();
      if (channels[0]) playChannelByUrl(channels[0].url);
    });
</script>

</body>
</html>
