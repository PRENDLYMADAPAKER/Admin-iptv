<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IPTV Premium</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      font-family: Arial, sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    header {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #111;
    }
    header img {
      height: 40px;
      margin-right: 10px;
    }
    video {
      width: 100%;
      height: auto;
      max-height: 40vh;
      background-color: #000;
    }
    .now-playing {
      padding: 10px;
      background-color: #222;
      display: flex;
      align-items: center;
    }
    .now-playing img {
      height: 30px;
      margin-right: 10px;
    }
    .epg-guide {
      padding: 10px;
      background-color: #1a1a1a;
    }
    .epg-guide div {
      margin: 5px 0;
    }
    .controls {
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background-color: #111;
    }
    .channel-grid {
      display: flex;
      transition: transform 0.3s ease;
      overflow: hidden;
      padding: 10px;
    }
    .channel-page {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: repeat(2, 1fr);
      gap: 10px;
      width: 100%;
      flex-shrink: 0;
    }
    .channel-card {
      background: #333;
      padding: 10px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .channel-card img {
      height: 40px;
      margin-right: 10px;
    }
    .category, .search, .favorites {
      flex: 1;
    }
    .favorites input {
      width: auto;
    }
  </style>
</head>
<body>
  <header>
    <img src="your-logo.png" alt="IPTV Premium" />
    <h1>IPTV Premium</h1>
  </header>

  <video id="videoPlayer" controls autoplay></video>

  <div class="now-playing">
    <img id="channelIcon" src="" alt="Channel Icon" />
    <strong id="channelName">Loading...</strong>
  </div>

  <div class="epg-guide" id="epgGuide">
    <div>Loading EPG...</div>
  </div>

  <div class="controls">
    <div class="search">
      <input type="text" id="searchInput" placeholder="Search channels..." />
    </div>
    <div class="category">
      <select id="categorySelect">
        <option value="All">All</option>
      </select>
    </div>
    <div class="favorites">
      <label><input type="checkbox" id="toggleFavorites"> Favorites</label>
    </div>
  </div>

  <div class="channel-grid" id="channelGrid">
    <!-- Pages will be injected here -->
  </div>

  <script>
    const m3uUrl = 'https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/main/IPTVPREMIUM.m3u';
    const epgUrl = 'https://tinyurl.com/DrewLive002-epg';
    const video = document.getElementById('videoPlayer');
    const channelName = document.getElementById('channelName');
    const channelIcon = document.getElementById('channelIcon');
    const channelGrid = document.getElementById('channelGrid');
    const categorySelect = document.getElementById('categorySelect');
    const toggleFavorites = document.getElementById('toggleFavorites');
    const searchInput = document.getElementById('searchInput');
    const epgGuide = document.getElementById('epgGuide');

    let channels = [], favorites = [], currentPage = 0, filteredChannels = [];

    function parseM3U(data) {
      const lines = data.split('\n');
      const parsed = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const info = lines[i];
          const url = lines[i + 1];
          const name = info.match(/,(.*)$/)[1];
          const logo = info.match(/tvg-logo="(.*?)"/)?.[1] || '';
          const group = info.match(/group-title="(.*?)"/)?.[1] || 'Others';
          parsed.push({ name, logo, group, url });
        }
      }
      return parsed;
    }

    function groupCategories() {
      const cats = [...new Set(channels.map(c => c.group))];
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    function renderChannels() {
      const container = document.createElement('div');
      container.className = 'channel-page';
      const toShow = filteredChannels.slice(currentPage * 2, currentPage * 2 + 2);
      toShow.forEach(ch => {
        const card = document.createElement('div');
        card.className = 'channel-card';
        card.innerHTML = `<img src="${ch.logo}"/><span>${ch.name}</span>`;
        card.onclick = () => {
          video.src = ch.url;
          channelName.textContent = ch.name;
          channelIcon.src = ch.logo;
          updateEPG(ch.name);
        };
        container.appendChild(card);
      });
      channelGrid.innerHTML = '';
      channelGrid.appendChild(container);
    }

    function applyFilters() {
      const keyword = searchInput.value.toLowerCase();
      const category = categorySelect.value;
      filteredChannels = channels.filter(c =>
        c.name.toLowerCase().includes(keyword) &&
        (category === 'All' || c.group === category) &&
        (!toggleFavorites.checked || favorites.includes(c.name))
      );
      currentPage = 0;
      renderChannels();
    }

    function updateEPG(channelName) {
      fetch(epgUrl)
        .then(res => res.text())
        .then(xmlText => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, 'text/xml');
          const programs = Array.from(xml.getElementsByTagName('programme'))
            .filter(p => (p.getAttribute('channel') || '').toLowerCase().includes(channelName.toLowerCase()));
          const now = new Date();
          const shows = programs.map(p => {
            const start = parseEPGTime(p.getAttribute('start'));
            const stop = parseEPGTime(p.getAttribute('stop'));
            const title = p.getElementsByTagName('title')[0]?.textContent || 'Untitled';
            return { start, stop, title };
          }).filter(show => now < show.stop);

          epgGuide.innerHTML = shows.slice(0, 3).map(show => `<div>ðŸ•’ ${show.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${show.title}</div>`).join('');
        });
    }

    function parseEPGTime(str) {
      const match = str.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/);
      return new Date(`${match[1]}-${match[2]}-${match[3]}T${match[4]}:${match[5]}:00Z`);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const res = await fetch(m3uUrl);
      const text = await res.text();
      channels = parseM3U(text);
      filteredChannels = [...channels];
      groupCategories();
      renderChannels();

      searchInput.oninput = applyFilters;
      categorySelect.onchange = applyFilters;
      toggleFavorites.onchange = applyFilters;

      channelGrid.addEventListener('touchstart', handleTouchStart, false);
      channelGrid.addEventListener('touchend', handleTouchEnd, false);
    });

    let xDown = null;
    function handleTouchStart(evt) {
      xDown = evt.touches[0].clientX;
    }
    function handleTouchEnd(evt) {
      if (!xDown) return;
      const xUp = evt.changedTouches[0].clientX;
      const xDiff = xDown - xUp;
      if (xDiff > 30 && (currentPage + 1) * 2 < filteredChannels.length) currentPage++;
      else if (xDiff < -30 && currentPage > 0) currentPage--;
      renderChannels();
      xDown = null;
    }
  </script>
</body>
</html>
