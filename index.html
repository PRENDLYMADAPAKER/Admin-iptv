<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IPTV Premium</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
    header { display: flex; align-items: center; gap: 10px; padding: 10px; background: #222; }
    header img { height: 40px; }
    #videoPlayer { width: 100%; height: 240px; background: #000; }
    #nowPlaying { padding: 10px; background: #1a1a1a; display: flex; align-items: center; gap: 10px; }
    #nowPlaying img { height: 40px; width: 40px; border-radius: 8px; }
    #epg { padding: 10px; background: #222; font-size: 14px; }
    #controls { display: flex; gap: 10px; padding: 10px; background: #1a1a1a; }
    #search, #category, #toggleFavorites { flex: 1; padding: 6px; border-radius: 5px; border: none; }
    #grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
    .channel-card { background: #333; border-radius: 10px; padding: 10px; cursor: pointer; position: relative; }
    .channel-card img { width: 100%; border-radius: 8px; }
    .channel-card .favorite-btn {
      position: absolute; top: 5px; right: 5px; background: transparent; border: none;
      color: #888; font-size: 18px; cursor: pointer;
    }
    .channel-card .favorite-btn.favorite { color: gold; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="IPTV Premium Logo" />
    <h1>IPTV Premium</h1>
  </header>
  <video id="videoPlayer" controls autoplay></video>
  <div id="nowPlaying">
    <img id="channelIcon" src="" alt="Icon" />
    <strong id="channelName">Now Playing</strong>
  </div>
  <div id="epg">Loading program info...</div>
  <div id="controls">
    <input id="search" placeholder="Search channels..." />
    <select id="category"></select>
    <button id="toggleFavorites">❤️</button>
  </div>
  <div id="grid"></div>

  <script>
    const m3uUrl = 'https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/main/IPTVPREMIUM.m3u';
    const epgUrl = 'https://tinyurl.com/DrewLive002-epg';

    let channels = [], favorites = [], filtered = [], currentCategory = 'All';

    const video = document.getElementById('videoPlayer');
    const channelName = document.getElementById('channelName');
    const channelIcon = document.getElementById('channelIcon');
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const category = document.getElementById('category');
    const toggleFavorites = document.getElementById('toggleFavorites');
    const epg = document.getElementById('epg');

    function parseM3U(data) {
      const lines = data.split('\n');
      const result = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const info = lines[i];
          const url = lines[i + 1];
          const nameMatch = info.match(/tvg-name="(.*?)"/);
          const logoMatch = info.match(/tvg-logo="(.*?)"/);
          const groupMatch = info.match(/group-title="(.*?)"/);
          result.push({
            name: nameMatch ? nameMatch[1] : 'Unknown',
            logo: logoMatch ? logoMatch[1] : '',
            group: groupMatch ? groupMatch[1] : 'Other',
            url
          });
        }
      }
      return result;
    }

    function loadFavorites() {
      const stored = localStorage.getItem('favorites');
      favorites = stored ? JSON.parse(stored) : [];
    }

    function saveFavorites() {
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    function isFavorite(name) {
      return favorites.includes(name);
    }

    function toggleFavorite(name) {
      if (isFavorite(name)) {
        favorites = favorites.filter(n => n !== name);
      } else {
        favorites.push(name);
      }
      saveFavorites();
      renderChannels();
    }

    function renderChannels() {
      grid.innerHTML = '';
      let list = filtered.length ? filtered : channels;
      if (toggleFavorites.classList.contains('on')) {
        list = list.filter(c => isFavorite(c.name));
      }
      for (const ch of list) {
        if (currentCategory !== 'All' && ch.group !== currentCategory) continue;
        const card = document.createElement('div');
        card.className = 'channel-card';
        card.innerHTML = `
          <img src="${ch.logo}" />
          <strong>${ch.name}</strong>
          <button class="favorite-btn ${isFavorite(ch.name) ? 'favorite' : ''}" onclick="event.stopPropagation(); toggleFavorite('${ch.name}')">★</button>
        `;
        card.onclick = () => {
          video.src = ch.url;
          channelName.textContent = ch.name;
          channelIcon.src = ch.logo;
          fetchEPG(ch.name);
        };
        grid.appendChild(card);
      }
    }

    function updateCategories() {
      const cats = [...new Set(channels.map(c => c.group))];
      category.innerHTML = '<option>All</option>' + cats.map(c => `<option>${c}</option>`).join('');
    }

    function fetchEPG(channel) {
      fetch(epgUrl).then(res => res.text()).then(xml => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, 'text/xml');
        const now = new Date();
        const items = [...doc.querySelectorAll('programme')]
          .filter(p => (p.getAttribute('channel') || '').toLowerCase().includes(channel.toLowerCase()))
          .slice(0, 3)
          .map(p => {
            const start = p.getAttribute('start').slice(8, 12);
            const stop = p.getAttribute('stop').slice(8, 12);
            return `${start}-${stop} ${p.querySelector('title')?.textContent}`;
          });
        epg.innerHTML = items.join('<br>') || 'No EPG info';
      });
    }

    search.oninput = () => {
      const q = search.value.toLowerCase();
      filtered = channels.filter(c => c.name.toLowerCase().includes(q));
      renderChannels();
    }

    category.onchange = () => {
      currentCategory = category.value;
      renderChannels();
    }

    toggleFavorites.onclick = () => {
      toggleFavorites.classList.toggle('on');
      renderChannels();
    }

    fetch(m3uUrl)
      .then(res => res.text())
      .then(text => {
        channels = parseM3U(text);
        loadFavorites();
        updateCategories();
        renderChannels();
      });
  </script>
</body>
</html>

