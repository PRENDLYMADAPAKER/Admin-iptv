<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPTV Web App</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
    .video-container { position: sticky; top: 0; background: #000; z-index: 1000; }
    video { width: 100%; height: 300px; background: #000; }
    .controls { padding: 1rem; }
    input, select { width: 100%; padding: 0.5rem; margin-bottom: 1rem; background: #222; color: #fff; border: none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
    .channel { background: #222; padding: 0.5rem; border-radius: 8px; cursor: pointer; }
    .channel img { width: 100%; height: 80px; object-fit: contain; background: #000; }
    .favorite { color: gold; font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="video-container">
  <video id="player" controls autoplay></video>
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Search channels..." />
  <select id="category"></select>
</div>

<div class="grid" id="channelGrid"></div>

<script>
  const m3uUrl = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/refs/heads/main/IPTVPREMIUM.m3u";
  const player = document.getElementById("player");
  const grid = document.getElementById("channelGrid");
  const searchInput = document.getElementById("search");
  const categorySelect = document.getElementById("category");

  let channels = [], filtered = [], favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
  let currentIndex = 0;

  function parseM3U(data) {
    const lines = data.split(/\r?\n/);
    const result = [];
    let current = {};

    lines.forEach(line => {
      if (line.startsWith("#EXTINF")) {
        const nameMatch = line.match(/,(.*)$/);
        const logoMatch = line.match(/tvg-logo="(.*?)"/);
        const groupMatch = line.match(/group-title="(.*?)"/);
        current = {
          name: nameMatch ? nameMatch[1] : "Unknown",
          logo: logoMatch ? logoMatch[1] : "",
          group: groupMatch ? groupMatch[1] : "Other"
        };
      } else if (line && !line.startsWith("#")) {
        current.url = line;
        result.push({ ...current });
      }
    });
    return result;
  }

  function updateCategoryOptions() {
    const allGroups = ["All", "Favorites", ...new Set(channels.map(c => c.group))];
    categorySelect.innerHTML = allGroups.map(g => `<option value="${g}">${g}</option>`).join("");
  }

  function renderChannels() {
    const search = searchInput.value.toLowerCase();
    const category = categorySelect.value;
    filtered = channels.filter(c =>
      (category === "All" || (category === "Favorites" && favorites.includes(c.url)) || c.group === category) &&
      c.name.toLowerCase().includes(search)
    );

    grid.innerHTML = filtered.map((ch, idx) => `
      <div class="channel" onclick="playChannel(${idx})">
        <img src="${ch.logo || 'https://via.placeholder.com/150x80?text=No+Logo'}" />
        <div>${ch.name}</div>
        <div class="favorite" onclick="toggleFavorite(event, '${ch.url}')">
          ${favorites.includes(ch.url) ? "★ Favorite" : "☆ Add Favorite"}
        </div>
      </div>
    `).join("");
  }

  function playChannel(index) {
    const ch = filtered[index];
    currentIndex = index;
    player.src = ch.url;
    player.play();
  }

  function toggleFavorite(event, url) {
    event.stopPropagation();
    if (favorites.includes(url)) {
      favorites = favorites.filter(f => f !== url);
    } else {
      favorites.push(url);
    }
    localStorage.setItem("favorites", JSON.stringify(favorites));
    renderChannels();
  }

  function swipeHandler(e) {
    const x = e.changedTouches[0].clientX;
    const direction = x < window.innerWidth / 2 ? 1 : -1;
    const nextIndex = currentIndex + direction;
    if (filtered[nextIndex]) {
      playChannel(nextIndex);
    }
  }

  player.addEventListener("touchend", swipeHandler);
  searchInput.addEventListener("input", renderChannels);
  categorySelect.addEventListener("change", renderChannels);

  fetch(m3uUrl)
    .then(res => res.text())
    .then(data => {
      channels = parseM3U(data);
      updateCategoryOptions();
      renderChannels();
      playChannel(0);
    });
</script>

</body>
</html>
